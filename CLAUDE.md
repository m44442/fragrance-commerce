# Claude AI アシスタント ルール

## プロジェクト概要
このプロジェクトはNext.jsで構築された香水ECアプリケーションです。

## 重要な注意事項・禁止事項

### Next.js App Router 動的ルート - 絶対遵守
- **重要**: Next.js 13+ App Routerでは動的ルートのparamsは非同期で取得する
- **正しい書き方**: `{ params }: { params: Promise<{ id: string }> }`
- **パラメータ取得**: `const { id } = await params;`
- **古い書き方は使用禁止**: `{ params }: { params: { id: string } }`

### データベースフィールド名 - 絶対遵守
- Order関連: `orderItems` (not `items`)、`total` (not `totalAmount`)、`shippingStatus`、`paymentStatus`
- Product関連: `isPublished` (not `isActive`)、`discountPrice` (not `samplePrice`)
- 実装前にPrismaスキーマを必ず確認すること

### NextAuth型定義 - 絶対遵守
- `session?.user?.isAdmin`は型エラーになる
- **正しい書き方**: `(session?.user as any)?.isAdmin`
- NextAuthのユーザー型にisAdminプロパティが含まれていないため

## 開発ガイドライン

### コードスタイル
- 既存のTypeScript/Reactの規約に従う
- 既存のコンポーネントパターンとスタイリング手法を使用する
- 一貫した命名規則を維持する

## 命名規則

### 意味のない単語の使用禁止
以下の要素に `common` や `util` のような意味のない単語を使うのは禁止します：

- ファイル名
- ディレクトリ名
- モジュール名
- 関数名
- 変数名

それらの単語は乱用されていて意味がなくなっており、見ても何の意味を持っているのか分からないためです。

## テスト

### テストコードは変更しない
テストコードの変更は基本的に禁止。テストは仕様を表すものであり、実装の正しさを検証するためのものです。

- テストが失敗している場合は、実装側を修正してください
- テストコードを実装に合わせるのは禁止
- テストが誤っていると思ったら質問してください
- 独自判断でテストを書き換えるのは禁止

### テストコードを変更しても良い例外
テストコードを変更して良い例外は以下のような場合です：

1. テストを追加するタスクを依頼されている
2. テストを修正するタスクを依頼されている
3. テストコードに明らかな構文エラーがある
4. テスト仕様が矛盾している（この場合は独自に判断するのではなく質問して確認）
5. テストコードがテスト対象のAPIと互換性がなくなっている（この場合は独自に判断するのではなく質問して確認）

### テストデータに依存した条件分岐は避ける
実装コードがテストで使用されている具体的なデータ値を特別扱いすることは基本的に禁止。

データに依存した実装は以下のような問題を引き起こします：
- 脆弱なテスト：テストデータが変更されると実装が機能しなくなる
- 隠れた仕様：特定のデータ名に対する特別な処理が明示的な仕様ではなく暗黙的になる
- 汎用性の欠如：実際の運用環境では機能しない可能性がある

### テスト駆動開発
テスト駆動開発では、テストコードを先に書き、その後に実装コードを書きます。まずテストコードを書いた後、実装コードを書く前に、テストコードがこれで正しいかユーザに確認してください。


### テスト・品質管理
- タスク完了前に必ずリントと型チェックを実行する：
  - `npm run lint` - コードリント
  - `npm run typecheck` - TypeScript型チェック
- 変更が既存機能を破壊していないことを確認する
- 実装完了前に必ずテストを実行し機能要件を満たすことを確認する
- テストを通すためだけの実装はしない、あくまで要件を満たしたものを確実に実装するためのテストであること

### Gitワークフロー
- ユーザーから明示的に要求された場合のみコミットする
- 既存のコミットメッセージパターンに従う
- 説明的なコミットメッセージを使用する

### ファイル管理
- 新規ファイル作成よりも既存ファイルの編集を優先する
- 絶対に必要な場合のみ新規ファイルを作成する
- 既存のプロジェクト構造と組織に従う

## よく使うコマンド
- `npm run dev` - 開発サーバー起動
- `npm run build` - 本番用ビルド
- `npm run lint` - ESLint実行
- `npm run typecheck` - TypeScriptコンパイラーチェック実行

## 購入フロー・データ管理
### Purchase テーブル中心の設計
- **重要**: 実際の購入データは`Purchase`テーブルに記録される
- `Order`テーブルは使用しない（単純化のため）
- 管理画面は`Purchase`テーブルから表示する
- 効率的でシンプルなデータ構造

### 購入データ作成ルール
- Stripe Webhook: `Purchase` のみ作成
- Checkout Success: `Purchase` のみ作成  
- 重複チェック: `userId` + `fragranceId` で既存確認
- 管理画面URL: `/admin/purchases`

## 備考
- 香水ECアプリケーション
- 主要技術：Next.js、TypeScript、React
- 現在のブランチ：main